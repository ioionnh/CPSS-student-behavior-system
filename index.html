<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกคะแนนพฤติกรรมนักเรียน</title>
    <style>
        /* Reset และ Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Kanit', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
            overflow-x: hidden; /* ป้องกันการเลื่อนแนวนอน */
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px; /* ปรับ padding แนวนอน */
            width: 100%;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 25px 15px; /* ปรับ padding แนวนอน */
            text-align: center;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }
        
        /* ปรับปุ่มให้สวยงามขึ้น */
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            border: none;
            padding: 10px 18px; /* ปรับขนาด padding */
            border-radius: 8px;
            font-size: 0.95rem; /* ปรับขนาดฟอนต์ */
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-decoration: none;
            margin: 3px; /* ปรับระยะห่าง */
            white-space: nowrap; /* ป้องกันข้อความในปุ่มขึ้นบรรทัดใหม่ */
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
        }
        
        .btn-remove {
            background: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #f8961e 0%, #f3722c 100%);
        }

        /* เพิ่มสไตล์สำหรับแท็บ */
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap; /* อนุญาตให้ขึ้นบรรทัดใหม่ */
            gap: 5px; /* ระยะห่างระหว่างปุ่ม */
        }
        
        .tab-btn {
            padding: 10px 15px;
            background: #eee;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-btn.active {
            background: #3a0ca3;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }

        /* ส่วนอื่นๆ เหมือนเดิมทั้งหมด */
        .panel {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap; /* อนุญาตให้ขึ้นบรรทัดใหม่ */
            gap: 10px; /* ระยะห่างระหว่างองค์ประกอบ */
        }
        
        .panel-title {
            font-size: 1.5rem;
            color: #3a0ca3;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            table-layout: fixed; /* ควบคุมความกว้างคอลัมน์ */
        }
        
        th, td {
            padding: 12px 10px; /* ปรับ padding */
            text-align: left;
            border-bottom: 1px solid #eee;
            word-wrap: break-word; /* อนุญาตให้คำยาวขึ้นบรรทัดใหม่ */
        }
        
        th {
            background: #3a0ca3;
            color: white;
            font-weight: 500;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #aaa;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        /* Login Section */
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
                padding-top: 20px;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                margin: 2px;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>ระบบบันทึกคะแนนพฤติกรรมนักเรียน</h1>
            </div>
        </header>

        <!-- Login Section -->
        <div class="login-container" id="loginSection">
            <h2 style="text-align: center; margin-bottom: 20px;">เข้าสู่ระบบ</h2>
            <div class="form-group">
                <label for="username"><strong>ชื่อผู้ใช้</strong></label>
                <input type="text" id="username" class="form-control" placeholder="กรอกรหัสผู้ใช้">
            </div>
            <div class="form-group">
                <label for="password"><strong>รหัสผ่าน</strong></label>
                <input type="password" id="password" class="form-control" placeholder="กรอกรหัสผ่าน">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">เข้าสู่ระบบ</button>
        </div>

        <!-- Student Panel -->
        <div class="panel" id="studentPanel">
            <div class="panel-header">
                <h2 class="panel-title">คะแนนพฤติกรรมของฉัน</h2>
                <button class="btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
            </div>
            <div id="studentInfo"></div>
            <table id="studentScoreTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">วันที่</th>
                        <th style="width: 40%;">รา��การ</th>
                        <th style="width: 20%;">คะแนนที่เปลี่ยนแปลง</th>
                        <th style="width: 20%;">โดย</th>
                    </tr>
                </thead>
                <tbody id="studentScoreBody">
                </tbody>
            </table>
            <div id="studentTotalScore" style="text-align: center; margin-top: 20px;"></div>
        </div>

        <!-- Teacher Panel -->
        <div class="panel" id="teacherPanel">
            <div class="panel-header">
                <h2 class="panel-title">จัดการคะแนนนักเรียน</h2>
                <div>
                    <button class="btn btn-add" onclick="openAddScoreModal()"><i class="fas fa-plus"></i> เพิ่ม/ลดคะแนน</button>
                    <button class="btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
                </div>
            </div>
            <table id="teacherStudentTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">รหัสนักเรียน</th>
                        <th style="width: 40%;">ชื่อนักเรียน</th>
                        <th style="width: 20%;">คะแนนรวม</th>
                        <th style="width: 20%;">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="teacherStudentBody">
                </tbody>
            </table>
        </div>

        <!-- Admin Panel -->
        <div class="panel" id="adminPanel">
            <div class="panel-header">
                <h2 class="panel-title">ระบบจัดการผู้ดูแล</h2>
                <div>
                    <button class="btn btn-add" onclick="openAddUserModal()"><i class="fas fa-user-plus"></i> เพิ่มผู้ใช้</button>
                    <button class="btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="openTab('adminStudents')">นักเรียน</button>
                    <button class="tab-btn" onclick="openTab('adminTeachers')">ครู</button>
                    <button class="tab-btn" onclick="openTab('adminLogs')">ประวัติการเปลี่ยนแปลง</button>
                </div>
                
                <div id="adminStudents" class="tab-content active">
                    <table id="adminStudentTable">
                        <thead>
                            <tr>
                                <th style="width: 20%;">รหัสนักเรียน</th>
                                <th style="width: 40%;">ชื่อนักเรียน</th>
                                <th style="width: 20%;">คะแนนรวม</th>
                                <th style="width: 20%;">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminStudentBody">
                            <tr>
                                <td>64001</td>
                                <td>นักเรียน หนึ่ง</td>
                                <td>-410</td>
                                <td><button class="btn btn-edit" onclick="editUser('64001')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                            <tr>
                                <td>64002</td>
                                <td>นักเรียน สอง</td>
                                <td>77</td>
                                <td><button class="btn btn-edit" onclick="editUser('64002')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                            <tr>
                                <td>64003</td>
                                <td>นักเรียน สาม</td>
                                <td>90</td>
                                <td><button class="btn btn-edit" onclick="editUser('64003')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                            <tr>
                                <td>64004</td>
                                <td>นักเรียน สี่</td>
                                <td>68</td>
                                <td><button class="btn btn-edit" onclick="editUser('64004')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                            <tr>
                                <td>64005</td>
                                <td>นักเรียน ห้า</td>
                                <td>77</td>
                                <td><button class="btn btn-edit" onclick="editUser('64005')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="adminTeachers" class="tab-content">
                    <table id="adminTeacherTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">รหัสครู</th>
                                <th style="width: 50%;">ชื่อครู</th>
                                <th style="width: 20%;">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminTeacherBody">
                            <tr>
                                <td>t001</td>
                                <td>ครู สมชาย</td>
                                <td><button class="btn btn-edit" onclick="editUser('t001')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                            <tr>
                                <td>t002</td>
                                <td>ครู สมหญิง</td>
                                <td><button class="btn btn-edit" onclick="editUser('t002')"><i class="fas fa-edit"></i> แก้ไข</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="adminLogs" class="tab-content">
                    <div id="adminLogsContainer" style="max-height: 500px; overflow-y: auto;">
                        <!-- Log entries will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Score Modal -->
        <div id="addScoreModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addScoreModal')">&times;</span>
                <h2 style="margin-bottom: 20px;">เพิ่ม/ลดคะแนนนักเรียน</h2>
                <div class="form-group">
                    <label for="scoreStudentId">นักเรียน</label>
                    <select id="scoreStudentId" class="form-control">
                        <!-- Options will be added by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="scoreChange">จำนวนคะแนน (บวก=เพิ่ม, ลบ=ลด)</label>
                    <input type="number" id="scoreChange" class="form-control" placeholder="เช่น 5 หรือ -3">
                </div>
                <div class="form-group">
                    <label for="scoreReason">เหตุผล</label>
                    <input type="text" id="scoreReason" class="form-control" placeholder="เช่น มาโรงเรียนสาย, ช่วยเหลือเพื่อน">
                </div>
                <button class="btn" onclick="submitScoreChange()"><i class="fas fa-save"></i> บันทึก</button>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
                <h2 style="margin-bottom: 20px;">เพิ่มผู้ใช้ใหม่</h2>
                <div class="form-group">
                    <label for="newUserType">ประเภทผู้ใช้</label>
                    <select id="newUserType" class="form-control">
                        <option value="student">นักเรียน</option>
                        <option value="teacher">ครู</option>
                        <option value="admin">ผู้บริหาร</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newUserId">รหัสผู้ใช้</label>
                    <input type="text" id="newUserId" class="form-control" placeholder="เช่น 64001 สำหรับนักเรียน">
                </div>
                <div class="form-group">
                    <label for="newUserName">ชื่อ-สกุล</label>
                    <input type="text" id="newUserName" class="form-control" placeholder="ชื่อผู้ใช้">
                </div>
                <div class="form-group">
                    <label for="newUserPassword">รหัสผ่าน</label>
                    <input type="password" id="newUserPassword" class="form-control" placeholder="รหัสผ่าน">
                </div>
                <button class="btn" onclick="addNewUser()"><i class="fas fa-user-plus"></i> เพิ่มผู้ใช้</button>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('editUserModal')">&times;</span>
                <h2 style="margin-bottom: 20px;">แก้ไขข้อมูลผู้ใช้</h2>
                <div class="form-group">
                    <label for="editUserId">รหัสผู้ใช้</label>
                    <input type="text" id="editUserId" class="form-control" disabled>
                </div>
                <div class="form-group">
                    <label for="editUserName">ชื่อ-สกุล</label>
                    <input type="text" id="editUserName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editUserPassword">รหัสผ่านใหม่ (เว้นว่างหากไม่ต้องการเปลี่ยน)</label>
                    <input type="password" id="editUserPassword" class="form-control">
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-edit" onclick="updateUser()"><i class="fas fa-save"></i> บันทึกการเปลี่ยนแปลง</button>
                    <button class="btn btn-remove" onclick="deleteUser()"><i class="fas fa-trash"></i> ลบผู้ใช้นี้</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ระบบเก็บข้อมูลแบบถาวร
        const STORAGE_KEY = 'studentBehaviorSystemData';
        
        // ข้อมูลเริ่มต้น
        const defaultData = {
            users: [
                { id: "64001", name: "นักเรียน หนึ่ง", password: "64001", role: "student", score: -410, logs: [
                    { date: "2023-05-01T09:00:00", change: 5, by: "ครู สมชาย", reason: "ช่วยเหลือเพื่อน" },
                    { date: "2023-05-03T10:30:00", change: -2, by: "ครู สมหญิง", reason: "ส่งงานช้า" },
                    { date: "2023-05-05T08:15:00", change: -413, by: "ครู สมชาย", reason: "ขาดเรียนหลายครั้ง" }
                ]},
                { id: "64002", name: "นักเรียน สอง", password: "64002", role: "student", score: 77, logs: [
                    { date: "2023-05-02T08:45:00", change: -5, by: "ครู สมหญิง", reason: "มาโรงเรียนสาย" },
                    { date: "2023-05-04T14:15:00", change: 2, by: "ครู สมชาย", reason: "ตอบคำถามในชั้นเรียน" },
                    { date: "2023-05-06T09:30:00", change: 80, by: "ครู สมหญิง", reason: "ชนะการแข่งขันวิชาการ" }
                ]},
                { id: "64003", name: "นักเรียน สาม", password: "64003", role: "student", score: 90, logs: [
                    { date: "2023-05-01T11:20:00", change: 3, by: "ครู สมชาย", reason: "ทำงานกลุ่มดี" },
                    { date: "2023-05-06T13:10:00", change: 4, by: "ครู สมหญิง", reason: "ช่วยครูยกของ" },
                    { date: "2023-05-08T10:00:00", change: -7, by: "ครู สมชาย", reason: "ไม่ส่งงาน" }
                ]},
                { id: "64004", name: "นักเรียน สี่", password: "64004", role: "student", score: 68, logs: [
                    { date: "2023-05-03T10:00:00", change: -3, by: "ครู สมชาย", reason: "ไม่ทำการบ้าน" },
                    { date: "2023-05-07T09:30:00", change: -2, by: "ครู สมหญิง", reason: "พูดคุยในชั้นเรียน" },
                    { date: "2023-05-09T14:00:00", change: 73, by: "ครู สมหญิง", reason: "พัฒนาการดีขึ้น" }
                ]},
                { id: "64005", name: "นักเรียน ห้า", password: "64005", role: "student", score: 77, logs: [
                    { date: "2023-05-02T15:00:00", change: 5, by: "ครู สมหญิง", reason: "ชนะการแข่งขัน" },
                    { date: "2023-05-05T08:20:00", change: -1, by: "ครู สมชาย", reason: "ลืมอุปกรณ์" },
                    { date: "2023-05-07T11:45:00", change: 73, by: "ครู สมชาย", reason: "มีน้ำใจช่วยเหลือเพื่อน" }
                ]},
                { id: "t001", name: "ครู สมชาย", password: "t001", role: "teacher" },
                { id: "t002", name: "ครู สมหญิง", password: "t002", role: "teacher" },
                { id: "admin", name: "ผู้บริหาร ใหญ่", password: "admin", role: "admin" }
            ],
            allLogs: []
        };

        // โหลดข้อมูลจาก localStorage
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                // สร้างข้อมูลเริ่มต้นและบันทึก
                initializeSampleLogs();
                return defaultData;
            }
            return JSON.parse(savedData);
        }

        // บันทึกข้อมูล
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // เริ่มต้นข้อมูลตัวอย่าง
        function initializeSampleLogs() {
            defaultData.allLogs = [];
            defaultData.users.forEach(user => {
                if (user.role === 'student' && user.logs) {
                    user.logs.forEach(log => {
                        defaultData.allLogs.push({
                            date: log.date,
                            studentId: user.id,
                            studentName: user.name,
                            change: log.change,
                            by: log.by,
                            reason: log.reason,
                            actionBy: log.by.split(' ')[1] // แยกรหัสครูจากชื่อ
                        });
                    });
                }
            });
            saveData(defaultData);
        }

        // ตัวแปรระบบ
        let users = [];
        let allLogs = [];
        let currentUser = null;

        // โหลดข้อมูลเมื่อเริ่มต้น
        function initializeSystem() {
            const data = loadData();
            users = data.users;
            allLogs = data.allLogs;
        }

        // เข้าสู่ระบบ
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            currentUser = users.find(user => user.id === username && user.password === password);
            
            if (currentUser) {
                document.getElementById('loginSection').style.display = 'none';
                
                switch(currentUser.role) {
                    case 'student':
                        showStudentPanel();
                        break;
                    case 'teacher':
                        showTeacherPanel();
                        break;
                    case 'admin':
                        showAdminPanel();
                        break;
                }
            } else {
                alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!');
            }
        }

        // ออกจากระบบ
        function logout() {
            currentUser = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentPanel').style.display = 'none';
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // แสดงแผงนักเรียน
        function showStudentPanel() {
            const panel = document.getElementById('studentPanel');
            panel.style.display = 'block';
            
            document.getElementById('studentInfo').innerHTML = `
                <p><strong>รหัสนักเรียน:</strong> ${currentUser.id}</p>
                <p><strong>ชื่อนักเรียน:</strong> ${currentUser.name}</p>
            `;
            
            const tbody = document.getElementById('studentScoreBody');
            tbody.innerHTML = '';
            
            if (currentUser.logs && currentUser.logs.length > 0) {
                currentUser.logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(log.date)}</td>
                        <td>${log.reason}</td>
                        <td class="${log.change > 0 ? 'positive' : 'negative'}">
                            ${log.change > 0 ? '+' : ''}${log.change}
                        </td>
                        <td>${log.by}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center;">ไม่มีประวัติการเปลี่ยนแปลงคะแนน</td>`;
                tbody.appendChild(row);
            }
            
            document.getElementById('studentTotalScore').innerHTML = `
                <h3>คะแนนรวม: <span class="${currentUser.score > 0 ? 'positive' : 'negative'}">${currentUser.score}</span></h3>
            `;
        }

        // แสดงแผงครู
        function showTeacherPanel() {
            const panel = document.getElementById('teacherPanel');
            panel.style.display = 'block';
            
            const tbody = document.getElementById('teacherStudentBody');
            tbody.innerHTML = '';
            
            const students = users.filter(user => user.role === 'student');
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td class="${student.score > 0 ? 'positive' : 'negative'}">${student.score}</td>
                    <td>
                        <button class="btn btn-add" onclick="openAddScoreModal('${student.id}')">
                            <i class="fas fa-edit"></i> จัดการคะแนน
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // แสดงแผงผู้ดูแล
        function showAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = 'block';
            
            // แท็บนักเรียน
            const studentTbody = document.getElementById('adminStudentBody');
            studentTbody.innerHTML = '';
            
            const students = users.filter(user => user.role === 'student');
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td class="${student.score > 0 ? 'positive' : 'negative'}">${student.score}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editUser('${student.id}')">
                            <i class="fas fa-edit"></i> แก้ไข
                        </button>
                    </td>
                `;
                studentTbody.appendChild(row);
            });
            
            // แท็บครู
            const teacherTbody = document.getElementById('adminTeacherBody');
            teacherTbody.innerHTML = '';
            
            const teachers = users.filter(user => user.role === 'teacher');
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.id}</td>
                    <td>${teacher.name}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editUser('${teacher.id}')">
                            <i class="fas fa-edit"></i> แก้ไข
                        </button>
                    </td>
                `;
                teacherTbody.appendChild(row);
            });
            
            // แท็บประวัติ
            const logsContainer = document.getElementById('adminLogsContainer');
            logsContainer.innerHTML = '';
            
            if (allLogs.length > 0) {
                allLogs.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `
                        <p><strong>${formatDate(log.date)}</strong></p>
                        <p>นักเรียน: ${log.studentName} (${log.studentId})</p>
                        <p>คะแนนที่เปลี่ยนแปลง: 
                            <span class="${log.change > 0 ? 'positive' : 'negative'}">
                                ${log.change > 0 ? '+' : ''}${log.change}
                            </span>
                        </p>
                        <p>เหตุผล: ${log.reason}</p>
                        <p>โดย: ${log.by}</p>
                        <hr style="margin: 10px 0; border-color: #eee;">
                    `;
                    logsContainer.appendChild(logEntry);
                });
            } else {
                logsContainer.innerHTML = "<p>ไม่มีประวัติการเปลี่ยนแปลงคะแนน</p>";
            }
        }

        // เปิดโมดอลเพิ่ม/ลดคะแนน
        function openAddScoreModal(studentId = null) {
            const modal = document.getElementById('addScoreModal');
            const select = document.getElementById('scoreStudentId');
            select.innerHTML = '';
            
            const students = users.filter(user => user.role === 'student');
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.id})`;
                if (studentId && student.id === studentId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            document.getElementById('scoreChange').value = '';
            document.getElementById('scoreReason').value = '';
            modal.style.display = 'flex';
        }

        // ส่งการเปลี่ยนแปลงคะแนน
        function submitScoreChange() {
            const studentId = document.getElementById('scoreStudentId').value;
            const change = parseInt(document.getElementById('scoreChange').value);
            const reason = document.getElementById('scoreReason').value;
            
            if (!studentId || isNaN(change) || !reason) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน!');
                return;
            }
            
            const student = users.find(user => user.id === studentId && user.role === 'student');
            if (student) {
                student.score += change;
                
                const today = new Date().toISOString();
                const logEntry = {
                    date: today,
                    change: change,
                    by: currentUser.name,
                    reason: reason
                };
                
                if (!student.logs) student.logs = [];
                student.logs.push(logEntry);
                
                // เพิ่มในประวัติทั้งหมด
                allLogs.push({
                    date: today,
                    studentId: student.id,
                    studentName: student.name,
                    change: change,
                    by: currentUser.name,
                    reason: reason,
                    actionBy: currentUser.id
                });
                
                saveData({ users, allLogs });
                closeModal('addScoreModal');
                
                // รีเฟรชแผงปัจจุบัน
                if (currentUser.role === 'teacher') {
                    showTeacherPanel();
                } else if (currentUser.role === 'admin') {
                    showAdminPanel();
                }
                
                alert('บันทึกการเปลี่ยนแปลงคะแนนเรียบร้อย!');
            }
        }

        // เปิดแท็บ
        function openTab(tabName) {
            // ซ่อนแท็บทั้งหมด
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ยกเลิกการเลือกปุ่มแท็บทั้งหมด
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // แสดงแท็บที่เลือก
            document.getElementById(tabName).classList.add('active');
            
            // เน้นปุ่มแท็บที่เลือก
            event.currentTarget.classList.add('active');
        }

        // เปิดโมดอลเพิ่มผู้ใช้
        function openAddUserModal() {
            document.getElementById('newUserType').value = 'student';
            document.getElementById('newUserId').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('addUserModal').style.display = 'flex';
        }

        // เพิ่มผู้ใช้ใหม่
        function addNewUser() {
            const userType = document.getElementById('newUserType').value;
            const userId = document.getElementById('newUserId').value;
            const userName = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPassword').value;
            
            if (!userId || !userName || !password) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน!');
                return;
            }
            
            if (users.some(u => u.id === userId)) {
                alert('มีรหัสผู้ใช้นี้อยู่แล้ว!');
                return;
            }
            
            const newUser = {
                id: userId,
                name: userName,
                password: password,
                role: userType
            };
            
            if (userType === 'student') {
                newUser.score = 80;
                newUser.logs = [];
            }
            
            users.push(newUser);
            saveData({ users, allLogs });
            
            closeModal('addUserModal');
            showAdminPanel();
            alert('เพิ่มผู้ใช้ใหม่เรียบร้อย!');
        }

        // แก้ไขผู้ใช้
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserPassword').value = '';
            
            document.getElementById('editUserModal').style.display = 'flex';
        }

        // อัปเดตผู้ใช้
        function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const userName = document.getElementById('editUserName').value;
            const password = document.getElementById('editUserPassword').value;
            
            const user = users.find(u => u.id === userId);
            if (user) {
                user.name = userName;
                if (password) {
                    user.password = password;
                }
                
                saveData({ users, allLogs });
                closeModal('editUserModal');
                showAdminPanel();
                alert('บันทึกการเปลี่ยนแปลงเรียบร้อย!');
            }
        }

        // ลบผู้ใช้
        function deleteUser() {
            if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้นี้?')) return;
            
            const userId = document.getElementById('editUserId').value;
            users = users.filter(u => u.id !== userId);
            
            // ลบประวัติที่เกี่ยวข้อง
            if (users.find(u => u.id === userId)?.role === 'student') {
                allLogs = allLogs.filter(log => log.studentId !== userId);
            } else {
                allLogs = allLogs.filter(log => log.actionBy !== userId);
            }
            
            saveData({ users, allLogs });
            closeModal('editUserModal');
            showAdminPanel();
            alert('ลบผู้ใช้เรียบร้อย!');
        }

        // ปิดโมดอล
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // จัดรูปแบบวันที่
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // เริ่มต้นระบบเมื่อโหลดหน้า
        window.onload = function() {
            initializeSystem();
            
            // เพิ่มสไตล์สำหรับข้อความคะแนน
            const style = document.createElement('style');
            style.textContent = `
                .positive { color: #2ecc71; font-weight: bold; }
                .negative { color: #e74c3c; font-weight: bold; }
                .log-entry {
                    background: white;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 5px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }
            `;
            document.head.appendChild(style);
        };
    </script>
</body>
</html>
